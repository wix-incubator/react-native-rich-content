## `Commands`

#### `yarn setup`
Clean everything that git ignores, install, build and install pods.
#### `yarn android:start || yarn ios:start`
Run the demo app on android/ios without listening to changes in the code.
#### `yarn android:start-watch || yarn ios:start-watch`
Build typescript and run the demo app on android/ios. Typescript watches changes in the code and compile again for each change- makes the demo app respond to changes in the native parts (meaning - not for the web-assets).
#### `yarn build`
Build typescript and then build the web-assets of the editor and the plugins.

## `Adding a plugin`

- Create a new folder with the plugin's name in packages
#### `Handle web assets`
- Create path in the new package: src/web-assets/src.
- In src/web-assets/src, create a ts file that exports a function called createPlugin. The function should return a web plugin for the editor.
```jsx
import { pluginImage } from 'wix-rich-content-plugin-image';
import 'wix-rich-content-plugin-image/dist/styles.min.css';

export function createPlugin() {
  return pluginImage();
}
```
- In src/web-assets/src, create index.ts. In it, require './{BUNDLED_SCRIPT_FILE_NAME_OF_CHOICE}' and export a getter of the field {CHOSEN_FIELD_NAME} of it.  The path shouldn't exist, but it will after the compilation to the dist folder.
```jsx
const js = require('./wix-image-plugin-script.js').scriptString;

export function getJsScriptStringAsset() {
  return js;
}
```
- In src/web-assets. Create a js file for build configuration. export the return value of @react-native-rich-content/web-assets-build-tools's createWebAssetsBuildTools with the config:

| Field             | Description                                                             |
|-------------------|-------------------------------------------------------------------------|
| intermediatesPath | Absolute path to intermediates folder                                   |
| distPath          | Absolute path to bundle generated by webpack (should be in dist folder) |
| filename          | BUNDLED_SCRIPT_FILE_NAME_IN_INTERMEDIATES                               |
| library           | Unique library name of plugin                                           |
| entry             | Absolute path to the file that exports `createPlugin`                   |
| fieldName         | Chosen field name                                                       |

Example:
```jsx
const { createWebAssetsBuildTools } = require('@react-native-rich-content/web-assets-build-tools');
const { resolve } = require('path');

const buildTools = createWebAssetsBuildTools({
  isDevMode: true,
  intermediatesPath: resolve('./intermediates'),
  distPath: resolve('./dist/wix-image-plugin-script.js'),
  filename: 'bundled-plugin-image.js',
  library: 'WIX_IMAGE_PLUGIN',
  entry: resolve('./src/create-plugin.ts'),
  fieldName: 'scriptString',
});

module.exports = buildTools;
```
- Create src/web-assets/webpack.config.js, import the object created with the build tools and export it's getWebpackConfig().
```jsx
const { getWebpackConfig } = require('./buildTools');

module.exports = () => getWebpackConfig();
```
- Create a build command in src/web-assets/package.json. it should run buildTools.prepareBuild, webpack, and buildTools.bundleWebAssets.
- Add the following fields to src/web-assets/package.json   
```json
{
  ...
  "main": "./dist/index.js",
  "types": "./dist/index.d.ts",
  ...
}
```
- Create src/web-assets/tsconfig.json. extend monorepo's root's tsconfig.web-assets.json, set outDir to './dist', rootDir to './src', include './src/index.ts' and everything it depends on.
```jsx
{
    "display": "web-assets",
    "extends": "../../../../tsconfig.web-assets.json",
    "compilerOptions": {
      "outDir": "./dist",
      "rootDir": "./src"
    },
    "files": ["src/asset-getter.ts", "src/index.ts"],
    "exclude": ["node_modules"],
  }
```
- Create src/web-assets/.eslintrc.json and copy into it this content:
```jsx
{
    "env": {
        "browser": true
    },
    "root": false
}
```
#### `Handle native`
- In the new package folder, create tsconfig. In it, extend monorepo's root's tsconfig.native.json, reference src/web-assets, exclude src/web-assets, include src, set outDir to dist and rootDir to src.
```json
{
  "display": "plugin-image",
  "extends": "../../tsconfig.native.json",
  "compilerOptions": {
    "outDir": "./dist",
    "rootDir": "./src"
  },
  "references": [
    {"path": "src/web-assets"}
  ],
  "exclude": ["node_modules", "src/web-assets"],
  "include": ["src"]
}
```
- In src, implement the editor plugin creator. Import '@react-native-rich-content/common''s createEditorAtomicPlugin function. Pass to it the script string imported from './web-assets', and as a second parameter, the string '{UNIQUE_LIBRARY_NAME_OF_PLUGIN}.createPlugin'. Export the result as the editor plugin creator.
```jsx
import { createEditorAtomicPlugin } from '@react-native-rich-content/common';
import { getJsScriptStringAsset } from './web-assets';
const scriptString = getJsScriptStringAsset();
const scriptWindowEntry = 'WIX_IMAGE_PLUGIN.createPlugin';
export const createEditorImagePlugin = createEditorAtomicPlugin(scriptString, scriptWindowEntry);
```
- In src/index.ts, export the editor plugin creator, viewer plugin creator and every util or type that you wish.
- In package.json, set name to '@react-native-rich-content/{PLUGIN_NAME}', set the fields "main": "./dist/index.js",
  "types": "./dist/index.d.ts".
  - In package.json's scripts. set preinstall to install src/web-assets. set build to run src/web-assets build and then run copyfiles -u 3 ./src/web-assets/dist/* ./dist/web-assets. This will copy the compiled web-assets to the package's dist folder.
 ```json
 {
  "name": "@react-native-rich-content/plugin-image",
  ...
  "main": "./dist/index.js",
  "types": "./dist/index.d.ts",
  ...
  "scripts": {
    "preinstall": "yarn --cwd src/web-assets install",
    "build-web-assets": "npm --prefix ./src/web-assets run build",
    "copy-web-assets": "copyfiles -u 3 ./src/web-assets/dist/* ./dist/web-assets",
    "build": "yarn build-web-assets && yarn copy-web-assets"
  }
  ...
}
```
#### `Handle monorepo's root`
- In tsconfig.json, add the path to the new package to the references array.
```json
{
  "display": "react-native-rich-content",
  "files": [],
  "references": [
    {
      "path": "./packages/common"
    },
    {
      "path": "./packages/editor"
    },
    {
      "path": "./packages/plugin-image"
    },
    {
      "path": "./packages/toolbar"
    },
    {
      "path": "./packages/viewer"
    },
    {
      "path": "./packages/web-assets-build-tools"
    },
  ]
}
```
- In package.json, add to 'build' script the command 'yarn workspace @react-native-rich-content/{NEW_PLUGIN_NAME} build'
```json
{
...
  "scripts": {
...
    "build": "tsc --build && yarn workspace @react-native-rich-content/editor build && yarn workspace @react-native-rich-content/plugin-image build",
...
  }
 ...
}
```
